---
title: myMiniDB:c++实现简易数据库-1-基本架构和环境构建
tags:
  - null
categories:
  - technical
  - null
toc: true
declare: true
date: 2022-11-28 21:45:43
---

[TOC]


<!-- more -->

> 学习自：
>
> * https://zhuanlan.zhihu.com/p/463791156

# 一、前言

秋招后的封控日子里，因为实在是无聊到游戏都已经玩腻，所以决定重整旗鼓开始学习，因为本身一直想学习C++，这次在看完《C++ Primer》第一部分后实在觉得直接撸书太无聊（是我现在太浮躁了吗…），遂找个项目想边做边练（当然遇到无法理解的内容便会重新滚回去看书了…）

因为网上C++相关的httpd项目太多了，所以找了一个实现简易数据库的项目来做，学习资料来自[知乎大佬：[氰化钾不爱打代码]](https://www.zhihu.com/column/c_1472652536327389184)

大佬对应代码的github在于：https://github.com/KCNyu/db_tutorial_cpp

我的学习仓库在于：https://github.com/xwjahahahaha/myMiniDB

> 因为大佬已经写了详细的tutorial，所以我只会在此记录核心内容 & 疑问/问题 & 扩充的理解？/ 后续能拓展的功能？，算是一个输出的途径吧…
>
> 所以文章内容转载居多，当然阅读的你也可以看原文学习后写点心得

# 二、项目基本架构

最终实现的架构如图：

<img src="https://pic4.zhimg.com/80/v2-342ade98e4b2c50cfe2eb6513c0f8d17_1440w.webp" alt="img" style="zoom: 67%;" />

前端 ***(front-end)*** （对应图中的`SQL Compiler`）

- 分词器 ***(tokenizer)***
- 解析器 ***(parser)***
- 代码生成器 ***(code generator)***

后端 ***(back-end)***

- 虚拟机 ***(virtual machine)***
- B树 ***(B-tree)***
- 分页 ***(pager)***
- 操作系统层接口 ***(os interface)***

`Accessories`部分：项目采用TDD的模式，也就是测试驱动开发，简单来说就是先写测试再写核心逻辑代码，跑过了就算完成一个需求

在此补一张MySQL的基本架构图：

<img src="http://xwjpics.gumptlu.work/qinniu_uPic/image-20221128215748760.png" alt="image-20221128215748760" style="zoom:50%;" />

（感觉麻雀虽小但是已经五脏俱全了！虽然没有链接池）

# 三、环境搭建

安装测试环境需要的软件：

```shell
sudo apt install -y ruby gem
sudo gem install rspec 				   # gem应该是和apt一样的linux上的包管理工具
```

> [RSpec](https://rspec.info/) is a testing tool for Ruby, created for behavior-driven development (BDD). rspec是一个专门用来测试ruby的测试工具，下面的代码就可以看出来与一般语言的测试框架大查不查，很容易看懂

编写第一个测试文件：

```rb
describe 'database' do
    def run_script(commands)
        raw_output = nil
        IO.popen("./db", "r+") do |pipe|
            commands.each do |command|
                pipe.puts command
            end
            
            pipe.close_write

            # Read entire ouput
            raw_output = pipe.gets(nil)
        end
        raw_output.split("\n")
    end

    it 'test exit and unrecognized command' do 
        result = run_script([
            "hello world",
            "HELLO WORLD",
            ".exit",
        ])
        expect(result).to match_array([
            "db > Unrecognized command: hello world",
            "db > Unrecognized command: HELLO WORLD",
            "db > Bye!",
        ])
    end
end
```

结果显示当然是错误的，因为我们没有db文件：

<img src="http://xwjpics.gumptlu.work/qinniu_uPic/image-20221128223218266.png" alt="image-20221128223218266" style="zoom:50%;" />

REPL：“读取-求值-输出”循环 ***(英語：Read-Eval-Print Loop，简称REPL)***，也被称做交互式顶层构件 ***(英語：interactive toplevel)***，是一个简单的，交互式的编程环境。

先实现和一个简易版本：

```c
#include <iostream>
#include <string>
using namespace std;

class DB
{
private:
    /* data */
public:
    void start();
    void print_prompt();
    bool parse_meta_command(string);
};



void DB::print_prompt() {
   cout << "db > ";
}

// 解析元命令
bool DB::parse_meta_command(string command) {
    if (command == ".exit") {
        cout << "Bye!" << endl;
        exit(EXIT_SUCCESS);
    }else {
        cout << "Unrecognized command: " << command << endl;
        return true;
    }

    return false;
}

void DB::start() {
    while(true) {
        print_prompt();

        string input_line;
        getline(cin, input_line);

        if (parse_meta_command(input_line)) {
            continue;
        }
    }
}

int main(int argc, char **argv) {
    DB db;
    db.start();
    return 0;
}
```

编译后并再次测试：

```shell
g++ db.cpp -o db
rspec spec db_test.rb
```

<img src="http://xwjpics.gumptlu.work/qinniu_uPic/image-20221129001047365.png" alt="image-20221129001047365" style="zoom: 67%;" />

测试成功！nice
