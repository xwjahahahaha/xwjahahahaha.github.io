---
title: 软中断使用率过高导致节点网络性能下降
tags:
  - null
categories:
  - technical
  - null
toc: true
declare: true
date: 2022-07-05 09:53:39
---

[TOC]

<!-- more -->

# 一、问题描述

（丹炉集群运维）k8s节点偶现CPU softirq使用率过高导致节点网络性能下降，影响训练任务执行

# 二、排查

对单核cpu进行profile，得到如下的火焰图：

![image-20220705095518759](http://xwjpics.gumptlu.work/qinniu_uPic/image-20220705095518759.png)

可以看到中心较宽的两个调用栈，可以看到出现较多的函数是`alloc_iova`

`softirq`很高的开销主要在`alloc_iova` 也就是分配`DMA`内存

# 三、分析结果

因为在该主机上开启`DMA`内存分配会导致`pytorch`的不可用，所以之前的策略是直接在该主机上关闭`DMA`，而关闭`DMA`却导致了分配`DMA`内存时软中断的巨大开销
