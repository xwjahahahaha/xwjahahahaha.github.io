---
title: CSAPP-7-链接
tags:
  - null
categories:
  - technical
  - null
toc: true
declare: true
date: 2022-05-28 19:50:09
---

[TOC]


<!-- more -->

> 参考：
>
> * 《CSAPP》

# 第七章 链接

## 1. 什么是链接？

链接是将各种代码和数据片段收集并组合成为一个单一文件的过程，随后这个文件可能会被加载运行

在最开始需要手动链接多个可重定位目标程序，现在这项工作由链接器(`linker`)负责

## 2. 链接的时机有哪些？

* 编译时链接：在源代码被翻译为机器代码的过程中链接其他文件实现
* 加载时链接：即程序被加载器加载到内存准备运行时链接
* 执行时链接：由应用程序自己来执行链接

## 3. 什么是编译器驱动程序？整体的过程是什么样的？

编译器驱动程序就是帮我们实现预处理、编译、汇编、链接的一套工具，简称编译器，常用的就是gcc

对于实例程序`main.c`：

```c
int sum(int *a, int n);

int array[2] = {1, 2};

int main() {
    int val = sum(array, 2);
    return val;
}
```

`sum.c`

```c
int sum(int *a, int n) {
    int i, s = 0;
    
    for (i = 0; i < n; i++) {
        s += a[i];
    }

    return s;
}
```

可以通过如下方式实现链接并得到最终的可执行程序`prog`：

```shell
gcc -o prog main.c sum.c
```

可以通过`-v`查看详细的步骤：

<img src="http://xwjpics.gumptlu.work/qinniu_uPic/image-20220529213612155.png" alt="image-20220529213612155" style="zoom:67%;" />

首先会将C的源程序`main.c`翻译为一个`ASCII`码的中间文件`main.i`：

<img src="http://xwjpics.gumptlu.work/qinniu_uPic/image-20220529213700443.png" alt="image-20220529213700443" style="zoom:67%;" />

![image-20220529213909243](http://xwjpics.gumptlu.work/qinniu_uPic/image-20220529213909243.png)

最后生成的可执行文件`prog`被shell调用操作系统中的加载器`loader`函数加载，将此可执行程序的代码和数据复制到内存，然后将控制流移动到这个程序的开头

## 4. 什么是静态链接？

例如`linux ld`链接器这样的方式：以一组可重定位目标文件和命令行作为参数，生成一个完成链接的、可以加载运行的可执行目标文件为输出

这就是静态链接

## 5. 静态链接器的核心任务有哪些？

在了解核心任务之前，先了解一下输入的**可重定向目标文件**的结构：

其由不同的代码和数据节(`section`)组成(这些都是从地址`0`开始)，每一节都是一串连续的字节序列

对应就主要有两个核心的任务：

* 符号解析：
  * 每个符号对应一个函数、一个全局变量等
  * 目的就是将每个符号引用和一个符号的定义关联起来
* 重定位(relocation)
  * 通过将这些符号定义与一个内存位置关联起来（确定符号的地址），重定位输入的可重定向目标文件中的节
  * 然后修改所有对这些符号的引用即使他们指向符号对应的地址（内存位置）
  * 链接器使用汇编器产生的**重定位条目(relocation entry)**的详细指令无脑的执行这些重定向步骤

关于链接器工作的基本事实/简单概括：

目标文件纯粹是字节块的集合。这些块中，有些包含程序代码，有些包含程序数据， 而其他的则包含**引导链接器和加载器的数据结构**。链接器将这些块连接起来，确定被连接块的运行时位置，并且修改代码和数据块中的各种位置

## 6. 目标文件的类别有哪些？

## 7. 详细介绍一下可重定位目标文件？
