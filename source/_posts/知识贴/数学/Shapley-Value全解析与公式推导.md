---
title: Shapley_Value全解析与公式推导
tags:
  - null
categories:
  - knowledge
  - null
toc: true
declare: true
date: 2021-08-18 19:05:33
---

[TOC]

> 学习参考资料：
>
> https://baike.baidu.com/item/shapley值法/5909624
>
> https://www.zhihu.com/question/23180647
>
> https://www.bilibili.com/video/BV1MA41137iv?from=search&seid=9563739550004489326
>
> https://kns.cnki.net/kcms/detail/detail.aspx?dbcode=CJFD&dbname=CJFD2013&filename=SSJS201304007&v=gINqgtNlfA%25mmd2BN%25mmd2BweW6Jg1PX2lPFQWcExU%25mmd2FRrv9Opswp8%25mmd2BXPAZYTlGhuoRIhIeCBaz

1951年，由诺贝尔得主Shapley提出，用于公平地定量**评估用户边际贡献度**的常用指标，起源于合作博弈，并用于广泛的领域，包括使用Shapley Value作为ML特征的选择，对训练数据的重要性进行排序

> 百度百科：
>
> 基于Shapley值进行联盟成员的利益分配体现了各盟员对联盟总目标的贡献程度，避免了分配上的平均主义，比任何一种仅按资源投入价值、[资源配置效率](https://baike.baidu.com/item/资源配置效率/11064708)及将二者相结合的分配方式都更具合理性和公平性，也体现了各盟员相互博弈的过程。但Shapley值法的利益分配方案尚未考虑联盟成员的风险分担因素，**实质上隐含着各盟员风险分担均等的假设**，**因此，对于联盟成员风险分担不等或风险分担存在较大差异的状况，需要根据风险分担大小对Shapley值法的利益分配方案做出适当的修正。**另需要注意利用Shapley值法进行利益分配应具备的前提条件是：要求每个参与人对在不同联盟组合状态下的利益要有一个较为准确的预期；此外，还要对这种复杂的计算方式有一个清楚的了解。知识联盟的总产出有时可能是不确定的，不同联盟组合状态下的收益也可能是不确定的，这会在一定程度上影响Shapley值法的应用。对于总效用不确定的情况，为了获取一个比较合理的不同联盟组合状态下的效用值，可以采用AHP法、ANP法、模糊数学等综合评价方法来估算各种联盟组合状态下的可能效用值，从而获得shapley值法所需要的数据，再进行具体利益分配上的计算 [1] 。

<!-- more -->

# 一、小问题

甲、乙、丙三人合作经商。倘若甲、乙合作可获利7万元，甲、丙合作可获利5万元，乙、丙合作可获利4万元，三人合作则获利10万元，每人单干各获利1万元。问三人合作时如何分配获利?

很显然，利益分配时，三人获利总和应为10万元。设甲、乙、丙三人分配获利为$x_1,x_2,x_3$，则有
$$
\begin{cases} x_1 \ge1, x_2 \ge 1,x_3 \ge 1 \\ x_1 + x_2 \ge 7, x_1+x_3\ge5,x_2+x_3\ge 4 \\ x_1 + x_2 +x_3 = 10 \end{cases}
$$
三人中如果谁获利小于1万元，则他就会单干，不会加入这个联盟。如果$x_1 +x_2 \ge 7$不成立，甲和乙就会组成一个小的联盟，而把丙抛在一边。

但是，这个系统有无穷多组解，例如$(x_1,x_2,x_3) = (4, 3, 3), (6,2,2),(5,3,2) $，甚至是(3，5，2)。很显然，站在乙或丙的角度，和甲合作都可以获得更大的利益，换言之，甲在他所参与的合作中贡献最大；同理，乙次之，丙贡献最小。因此，像$(5,3,2),(\frac{14}{3}, \frac{11}{3}, \frac{5}{3})$都是合理的解。哪一个更合理？因此应该有一种圆满的利益分配方法。

这类问题称为**n人[合作对策](https://baike.baidu.com/item/合作对策)**。L.S.Shapley在1953年给出了解决该问题的一种方法，称为**Shapley值法**。

# 二、数学抽象

下面先给出**合作对策**的一般模型。记$I=\{1,2,...,n\}$为n个合作人的集合。若对于$I$的任何子集$s \subseteq I$

都有一个实数v(s)与之对应，且满足下列条件：

1. $v(\varnothing) = 0$，其中$\varnothing$为空集。
2. 对于任意两个不交子集$s_1,s_2 \in I$，都有$v(s_1 \cup s_2 )\ge v(s_1)+v(s_2) $，则称v(s)为定义在$I$上的一个**特征函数**。

在实际问题中，**$v(s)$就是各种联盟的获利**，而第二个条件表明**任何情况下合作至少总比单干或者小团体的合作来得有利**。

合作对策就是需要确定**每个人获得的利益$\varphi_i(v)$**，或者对全体成员来讲就是向量$\varphi(v)=(\varphi_1(v),\varphi_2(v),\varphi_3(v)...)$

> <font color='#39b54a'>在合作优于单干的前提下，各种联盟中需要确定每个人的利益也就是确定$\varphi$向量,以实现确定**最公平**的联盟组合以及利益方式</font>

按照前例的分析，我们知道合理的分配需要满足$\sum_{i\in s} \varphi_i(v) \ge v(s)$当$s=I$时等号成立

> <font color='#39b54a'>这个式子从上面的例子中很好理解，每个人确定的利益之和要大于所有可能的联盟组合的利益，就如上面例子中所有组合都是$\ge$一样，当$s=I$等号成立就是上面例子的$x_1+x_2+x_3=10$</font>

其实，到这里也只是一个抽象上的数学总结，并没有给出限制（与上面例子一样），满足这样的条件结果还是有很多

# 三、Shapley公理

Shapley给出了**一组对策应满足的公理**，并证明了在这些公理下合作对策是<font color='#e54d42'>**唯一**</font>的。

1. 对称性

   设$\pi$是$I=\{1,2,…,n\}$的一个序列，对于$I$的任意子集$s = \{i_1,i_2,i_3,...,i_n\}$,有$\pi s = \{\pi i_1,...,\pi i_n\}$。若在定义特征函数$w(s)=v(\pi s)$,则对于每个$i\in I$都有$\varphi_i(w)=\varphi_{\pi i}(v)$

   > <font color='#39b54a'>$\varphi_i(w) = \varphi_i(v(\pi s)) = \varphi_i(v(\pi)v(s)) = \varphi_{\pi i}(v(s))= \varphi_{\pi i}(v)$</font>
   >
   > <font color='#39b54a'>**这表示合作获利的分配不随每个人在合作中的记号或次序变化。**</font>

2. 有效性

   合作各方获利总和等于合作获利：$\sum_{i\in s} \varphi_i(v) = v(I)$

   > <font color='#39b54a'>上面的抽象中的大于只有在$s \subset I$的情况下产生，计算出各个节点的Shapley值最终的和应该与总体联盟的总利益相等，否则无效</font>

3. 冗员性

   若对于包含成员i的所有子集s都有$v(s / \{i\} )= v(s)$则$\varphi_i(v)=0$，其中$s / \{i\}$为集合s去掉元素i后的集合

   > <font color='#39b54a'>这说明如果一个成员对于任何他参与的合作联盟都没有贡献，则他不应当从全体合作中获利。</font>

4. 可加性

   若在$I$上有两个特征函数$v_1,v_2$，则有$\varphi(v_1+v_2)=\varphi(v_1)+\varphi(v_2)$ ,

   > <font color='#39b54a'>**这表明有多种合作时，每种合作的利益分配方式与其他合作结果无关。**例如对于i来说对于两次合作S1、S2分别计算个人收益之和与两次合作总收益之和再计算个人收益之和是相同的</font>

Shapley证明了满足这四条公理的$\varphi(v)$是唯一的（**主要证明的就是有效性**），并且公式为：

$\varphi_i(v)=\sum_{s\in S_i}w(|s|)[v(s)-v(s/\{i\})]$

其中，**$S_i$是$I$中包含成员i的所有子集形成的集合**，$|s|$是集合S元素个数，**$w(|s|)$是加权因子**且有

$w(|s|)=\frac{(|s|-1)!(n-|s|)!}{n!}$

# 四、公式推导

<font color='#39b54a'>**边际贡献**</font>

$v(s)-v(s/\{i\})$是成员i在参与合作s中的贡献也叫做**边际贡献（marginal contribution）**，边际贡献是考察是否公平的主要考量，**先不考虑权重$\sum_{s\in S_i}[v(s)-v(s/\{i\})]$这部分就代表了对于i来说自己对于所有包含自己的S合作中自己的边际贡献**，如果再乘上每一个S中对应的权重那么就构成了i的Shapley值

<font color='#39b54a'>**权重**</font>

从公式中可以看出：**权重的计算只与合作s集合的大小有关，而合作s的大小就是代表着几方合作**

现在对于i，计算其Shapley公式中的权重：

我们画出权重分配树：

![image-20210818183438732](http://xwjpics.gumptlu.work/qinniu_uPic/image-20210818183438732.png)

* 根节点代表当前对象即i，也对应着树第一层

* 第二层代表合作人数/几方合作

  例如1方合作就是只有i一个人，两方合作例如i和s中其他一个人，图中的标号就表示是几方合作

  对于大于1方的合作其孩子即分支的数量计算由排列组合可轻松得知，例如两方合作，一个确定一定是i了，剩下一个人就一定从$(n-1)$中选择一个(n表示总参与人数即$|I|$), 所有的可能就是$C_{n-1}^1$, 其他同理

* 第三层是叶子节点，由叶子到根就代表合作s的人员组成，例如图中{1,2}

那么怎么计算权重呢，Shapley采用了**平均的方法：**

按分支平均，第一层到第二层共有n个分支，所以每个分支的权重为$\frac{1}{n}$

第二层到第三层的分支数要分开讨论，对于合作人数1来说就是1即$C_{n-1}^0$，对于合作人数2来说其分支数为$C_{n-1}^1$所以每个分支的平均权重为$\frac{1}{C_{n-1}^1}$，剩下的同理

现在对于每个叶子节点也就是**每一种包含i的合作s**，权重的计算就很明确了，例如叶子$\{1,2\}$其权重就是：$\frac{1}{n} * \frac{1}{C_{n-1}^1} = \frac{1}{nC_{n-1}^1}$ 

那么，我们回归到函数$w(|s|)$, 我们需要计算出这样的通式来表示这个函数，不难写出每个分支权重的通式：

$\frac{1}{n} * \frac{1}{C_{n-1}^{|s|-1}}$

上式通过化简就可以推导出$w(|s|)$的函数了：

<img src="http://xwjpics.gumptlu.work/qinniu_uPic/image-20210818185451860.png" alt="image-20210818185451860" style="zoom:50%;" />

# 五、例子助理解

对于上面的问题一，下面就可以计算出来了：

<img src="http://xwjpics.gumptlu.work/qinniu_uPic/image-20210818190325120.png" alt="image-20210818190325120" style="zoom:50%;" />

此外，知乎上也有大佬给出了一个详细的例子，可以加大理解程度：

已知：

v({1})=100,v({2})=125,v({3})=50

v({1,2})=270,v({2,3})=350,v({1,3})=375

v({1,2,3})=500

则计算过程可用图标画出：

![image-20210817223749561](http://xwjpics.gumptlu.work/qinniu_uPic/image-20210817223749561.png)

则各个节点/代理的Shapley值为：

![chcasT](http://xwjpics.gumptlu.work/qinniu_uPic/chcasT-20210818190613860.png)

> <font color='#e54d42'>从这里可以看出，计算Shapley的值其实过程可以大致概括为：在$n!$次全排列中计算节点的边际贡献的**平均值**</font>

# 六、各种角度理解公式

Shapley值是各种各样具有不同良好性质的解中最重要的一种，它将成本或者收益按照所有的边际成本进行分摊,即**每个参与人获得的利益等于参与人对所有联盟的边际贡献的平均值**

Shapley是满足匿名性、有效性、可加性和虚拟性四个性质的**唯一**的解

不同的思考角度都可以得出上述的权重计算公式，列举如下：

* 从构造联盟角度-总体平等性

  ![Gfqpkl](http://xwjpics.gumptlu.work/qinniu_uPic/Gfqpkl.png)

  （这里的s就是$|s|$）

  这里最终的结果与我们上文讨论的结果一样，但是思考的方式不同

  > <font color='#e54d42'>**重点突出：每个随机排序的概率相等，保持总体平等性**</font>

* 从联盟内外平等性角度-平均加权

  ![image-20210819005223383](http://xwjpics.gumptlu.work/qinniu_uPic/image-20210819005223383.png)

  这就是上面介绍的shapley值权重计算的主要思路，结果都是一样的

  > <font color='#e54d42'>**所有规模出现的概率是相同的，相同的规模中每一个联盟的概率是相同的**</font>

* 从联盟中参与人贡献平等性的角度-平等贡献性

  ![sOX2of](http://xwjpics.gumptlu.work/qinniu_uPic/sOX2of.png)

  > <font color='#e54d42'>**贡献的平等性（不是贡献值的平等性）**</font>

# 七、特征函数的考量

## 1. 污水处理厂典例

![](http://xwjpics.gumptlu.work/qinniu_uPic/rrwszp.png)

<img src="http://xwjpics.gumptlu.work/qinniu_uPic/Z03bKG.png" alt="Z03bKG" style="zoom: 67%;" />

注意：如果联合建厂，那么污水处理厂应该建立在下游城镇。例如1，2联合建厂，那么按照河流的流向应该将厂建立在2城镇

---

答案：分情况列出五种情况：

![8c1T33](http://xwjpics.gumptlu.work/qinniu_uPic/8c1T33.png)

![mUl6AV](http://xwjpics.gumptlu.work/qinniu_uPic/mUl6AV.png)

可以得出联合建厂的总投资最少，那么下一步该怎样进行利益的分配呢？？ shapley值的计算！

第一步也是最关键的一步就是定义**特征函数$V(s)$**

我们定义特征函数$V(s)$为**联合建厂比单独建厂节约的投资**

![DlKbX2](http://xwjpics.gumptlu.work/qinniu_uPic/DlKbX2.png)

计算后可得到：

![3If8lh](http://xwjpics.gumptlu.work/qinniu_uPic/3If8lh.png)

最后的分担应该就是在每个城镇单独建厂的资金中减去其能节约的资金：

![hgzh4U](http://xwjpics.gumptlu.work/qinniu_uPic/hgzh4U.png)

---

观察结果，不难看出城镇2的贡献最大分担最小，重要度/贡献度的排序应该是2，1，3，但是考虑现实生活中，城镇3处于最下游，考虑到污水处理厂对附近居民的影响, 处在下游的城镇重要性应该更大, 城镇理应获得更多的利润分配比，这与这样的结果是有点不符合的。

其实重点在于考虑构建特征函数时没有把所有的因素考虑进去，上面的例子只考虑了污水量以及距离两个因素，而没有有考虑到地理位置因素，是否需要添加不能光靠猜想，而是要通过**数据验证**

> <font color='#e54d42'>**特征函数的设计需要将因素考虑全面**</font>

## 2. 单因素分析

**通过将特征函数中其他因素保持相同，将需要考量的单个因素控制变量来考察其是否一个合理的因素**，这就是对于单因素是否添加到特征函数的分析过程

对于上面的例子的所有因素：{污水量、距离、地理位置} 考虑地理位置因素是否需要：

将三个城镇的污水量、距离控制相同，将地理环境改变，分别为原题河流**上下游环境**和**环湖泊环境（没有上下游，1与3对称）**

<img src="http://xwjpics.gumptlu.work/qinniu_uPic/P4XtY4.png" alt="P4XtY4" style="zoom:67%;" />

在计算之前，先讨论一下建厂方案的一般拟定：

* 湖泊环境下污水厂总是建在污水量最大的城市, 这样才能使得流动的污水量最少, 节约管道费用, 进而提高利润
* 河流环境下, 污水处理厂 总是建在下游城镇, 体现了上下游的地理位置作用，方便污水流动

> <font color='#39b54a'>注意：要将建厂方案与利益分配/重要性区别开来，建厂方案决定总利润（且上面的计算合作利润最高所以只建一个厂），利益分配决定单人利益</font>

按照这个拟定，下面的表格中建厂默认河流中在3，湖泊建在污水量大的城镇

可得出下列表格，利润大小代表重要程度：

![Tb1RJH](http://xwjpics.gumptlu.work/qinniu_uPic/Tb1RJH.png)

可看出：

* 不论是河流还是湖泊2都是最重要的/贡献最大的，1，3相同；
* 从河流换到湖泊，2的重要性降低，1，3的重要性提高

所以，结论是**上下游的地理环境因素不会作用于<u>单个</u>城镇的重要性，上下游位置优势会影响总体的利润值和利润分配**

进一步研究污水量因素对于城镇2重要性的影响，仅改变城镇2的污水量其他因素不变，可得以下表：

![EWHAFG](http://xwjpics.gumptlu.work/qinniu_uPic/EWHAFG.png)

可得出：

* 在**湖泊**环境下, 城镇1和3的重要性是相同的, 两者完全对称
* 河流环境下, 当城镇2的污水量小于城镇1和3时, 城镇3的利润比大于城镇1的利润比；当大于时，3小于1

> <font color='#e54d42'>这里就完全体现了问题：当污水量是{5,6,5}时，随着2的污水量提升，1分配的利益越多，而建厂在3的利益却逐渐的减少！</font>

所以说明了：**下游的优势作用并不能给下游个体带来更大利润，只是在全体上的利润更优**

例如，当城镇2污水量大于1，3时，河流下3的下游优势只体现在全局的利润而不体现在个人，相反个人的利润比例还会减小

综上可知, **地理位置的优势不能转化为利润上的优势时, 值便无法体现这种优势**

> <font color='#e54d42'>**shapley 值只能体现那些带来利润多寡的因素，换句话说：忽略了无法直接转化为利润的因素**</font>

# 八、shapley的局限性

## 1. 计算量

需要知道所有合作的利润，即要定义$I=\{1,2,3,...,n\}$的所有子集（$2^n-1$个）特征函数，在实际中难以做到

其次，公式本身计算随着节点的提升是NP难的问题

## 2. 优势即缺点

优势：利润分配上是平等的

缺点：忽略了无法转换为利润的因素

根源在于设定是使用Shapley值时参与人都是平等的，**有些因素不能够直接影响利润改变而是造成了地位的不平等**，但是在利润分配时各个参与人的地位是不同的，这些因素也不会在利润分配上体现

对于此项缺点也有了很多的研究，例如引入权重等









